#!/bin/bash

# This script creates a new user in the "bashuntu" shell, provided the following checks pass:
# 1. Does the user have permission to execute this command?

# No longer using this method, but I'm leaving it in just in case we decide against it.
#username=$(awk 'NR == 1' "$root_dir/system_files/config/.logged_in")

root_dir=$(awk 'NR == 1' ../config/.root_dir)
username="$1"
user_group="$2"
password="password"
new_username="$3"
new_user_group="$4"

if [ "$user_group" == "power" ] || [ "$username" == "dev" ]; then		# don't forget to remove "dev"
	if [ -z "$new_username" ]; then
		echo "What would you like to call this user?"
		read new_username
	fi
	loop_count=0
	while read x; do
		loop_count=$((loop_count + 1))
		if [[ "$x" == *"$new_username"* ]]; then	# this will give false positives (e.g. "ken" will give false positive for "kenny")
			echo "mkusr: User $new_username already exists!"
			echo "mkusr: Exiting..."
			exit 1;
		fi
	done < <(cat "$root_dir/system_files/config/users")
	echo "Enter a password for $new_username ..."
	read -s password
	echo "Enter again to confirm..."
	read -s password2
	if [[ "$password" == "$password2" ]]; then
		pass_length=${#password}
		if (( $pass_length < 8 )); then
			echo "mkusr: Password must be 8 characters or more!"
			echo "mkusr: Exiting..."
			exit 3
		fi
		spec_char=0
		upper_char=0
		lower_char=0
		num_char=0
		for (( i=0; i<${#password}; i++ )); do
			num='^[0-9]+$'
			low_char='[a-z]+$'
			up_char='[A-Z]+$'
			spc_char='['!'@#\$%^\&*()_+]'
			if [[ ${password:$i:1} =~ $num ]]; then
				num_char=$((num_char + 1))
			elif [[ ${password:$i:1} =~ $low_char ]]; then
				lower_char=$((lower_char + 1))
			elif [[ ${password:$i:1} =~ $up_char ]]; then
				upper_char=$((upper_char + 1))
			elif [[ ${password:$i:1} =~ $spc_char ]]; then
				spec_char=$((spec_char + 1))
			else echo "'${password:$i:1}' is not allowed!"; echo "mkusr: Exiting..."; exit 5
			fi
		done
		if (( $spec_char < 2 )); then
			echo "mkusr: Passwords must contain at least 2 special characters!"
			echo "mkusr: Exiting..."; exit 6
			if (( $upper_char < 2 )); then
				echo "mkusr: Passwords must contain at least 2 uppercase characters!"
				echo "mkusr: Exiting..."; exit 6
				if (( $lower_char < 2 )); then
					echo "mkusr: Passwords must contain at least 2 lowercase characters!"
					echo "mkusr: Exiting..."; exit 6
					if (( $num_char < 2 )); then
						echo "mkusr: Passwords must contain at least 2 numbers!"
						echo "mkusr: Exiting..."; exit 6
					fi
				fi
			fi
		fi
		if [ -z "$new_user_group" ]; then
		echo "What group should this user belong to? power | general | intern"
		read new_user_group
		fi
		valid_user_group=0
		if [[ "$new_user_group" == "power" ]]; then
			valid_user_group=$(( valid_user_group + 1 ))
		elif [[ "$new_user_group" == "general" ]]; then
			valid_user_group=$(( valid_user_group + 1 ))
		elif [[ "$new_user_group" == "intern" ]]; then
			valid_user_group=$(( valid_user_group + 1 ))
		fi
		if (( $valid_user_group == 0 )); then
			echo "mkusr: $new_user_group is not a valid user group!"
			echo "mkusr: Exiting..."
			exit 7
		elif (( $valid_user_group == 1 )); then
			echo "$new_username $password $new_user_group" >> "$root_dir/system_files/config/users"
			echo "mkusr: $new_username has been added as a new user!
			mkusr: Exiting..."
		else echo "mkusr: $new_user_group is not a valid user group!"; echo "mkusr: Exiting..." exit 7
		fi
	else echo "mkusr: Passwords do not match! Exiting mkusr..."; exit 4
	fi
else echo "mkusr: Permission denied!"; exit 2
fi
