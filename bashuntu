#!/bin/bash
# This serves as the main entry point to the pseudo-shell.

set -o pipefail		# trace error through pipes
set -o errtrace		# trace error through "time command" and other functions

# Function for catching and printing errors through pipes
	# The syntax for calling this to correctly output errors is:
	# trap 'error ${LINENO} ${?}' ERR
error() {
	job="$0"
	last_line="$1"
	last_error="$2"
	echo "ERROR in ${job} : line ${last_line} with exit code ${last_error}"
	exit 1
}

root_dir=$(pwd)

echo -n "Initializing shell..."
if does_admin_account_exist=$(cat $root_dir/system_files/config/users | grep "admin"); then
	if [[ $does_admin_account_exist == *"admin"* ]]; then
		echo "[ok]"
		echo "WARNING! Admin account has not been setup yet! Creating Admin account now..."
		if $root_dir/system_files/bin/sys_bin/setup_admin; then
			echo "Proceeding to login screen..."
			$root_dir/system_files/bin/sys_bin/login
		else trap 'error ${LINENO} ${?}' ERR
		fi
	else
		echo "Proceeding to login screen..."
		$root_dir/system_files/bin/sys_bin/login.sh	# admin account has been created. Run login.sh
	fi
else trap 'error ${LINENO} ${?}' ERR
fi
